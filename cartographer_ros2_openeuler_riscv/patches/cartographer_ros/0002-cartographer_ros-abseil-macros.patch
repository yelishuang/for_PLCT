From 2dc5d248a243e37d7977205fc4a462fb259c2eea Mon Sep 17 00:00:00 2001
From: Cody Gu <gujiaqi@iscas.ac.cn>
Date: Fri, 12 Dec 2025 17:08:56 +0800
Subject: [PATCH] chore(deps): migrate abseil macros to new definitions

---
 .../include/cartographer_ros/map_builder_bridge.h      |  6 +++---
 .../include/cartographer_ros/metrics/internal/gauge.h  |  2 +-
 .../cartographer_ros/metrics/internal/histogram.h      |  4 ++--
 cartographer_ros/include/cartographer_ros/node.h       |  4 ++--
 cartographer_ros/src/occupancy_grid_node_main.cpp      |  8 ++++----
 .../include/cartographer_rviz/drawable_submap.h        | 10 +++++-----
 .../include/cartographer_rviz/submaps_display.h        |  2 +-
 7 files changed, 18 insertions(+), 18 deletions(-)

diff --git a/cartographer_ros/include/cartographer_ros/map_builder_bridge.h b/cartographer_ros/include/cartographer_ros/map_builder_bridge.h
index b2c00b7..9c1befd 100644
--- a/cartographer_ros/include/cartographer_ros/map_builder_bridge.h
+++ b/cartographer_ros/include/cartographer_ros/map_builder_bridge.h
@@ -95,7 +95,7 @@ class MapBuilderBridge {
   GetTrajectoryStates();
   cartographer_ros_msgs::msg::SubmapList GetSubmapList(rclcpp::Time node_time);
   std::unordered_map<int, LocalTrajectoryData> GetLocalTrajectoryData()
-      LOCKS_EXCLUDED(mutex_);
+      ABSL_LOCKS_EXCLUDED(mutex_);
   visualization_msgs::msg::MarkerArray GetTrajectoryNodeList(rclcpp::Time node_time);
   visualization_msgs::msg::MarkerArray GetLandmarkPosesList(rclcpp::Time node_time);
   visualization_msgs::msg::MarkerArray GetConstraintList(rclcpp::Time node_time);
@@ -107,13 +107,13 @@ class MapBuilderBridge {
                          const ::cartographer::common::Time time,
                          const ::cartographer::transform::Rigid3d local_pose,
                          ::cartographer::sensor::RangeData range_data_in_local)
-      LOCKS_EXCLUDED(mutex_);
+      ABSL_LOCKS_EXCLUDED(mutex_);
 
   absl::Mutex mutex_;
   const NodeOptions node_options_;
   std::unordered_map<int,
                      std::shared_ptr<const LocalTrajectoryData::LocalSlamData>>
-      local_slam_data_ GUARDED_BY(mutex_);
+      local_slam_data_ ABSL_GUARDED_BY(mutex_);
   std::unique_ptr<cartographer::mapping::MapBuilderInterface> map_builder_;
   tf2_ros::Buffer* const tf_buffer_;
 
diff --git a/cartographer_ros/include/cartographer_ros/metrics/internal/gauge.h b/cartographer_ros/include/cartographer_ros/metrics/internal/gauge.h
index f311ab1..26d0caf 100644
--- a/cartographer_ros/include/cartographer_ros/metrics/internal/gauge.h
+++ b/cartographer_ros/include/cartographer_ros/metrics/internal/gauge.h
@@ -71,7 +71,7 @@ class Gauge : public ::cartographer::metrics::Gauge {
 
   absl::Mutex mutex_;
   const std::map<std::string, std::string> labels_;
-  double value_ GUARDED_BY(mutex_);
+  double value_ ABSL_GUARDED_BY(mutex_);
 };
 
 }  // namespace metrics
diff --git a/cartographer_ros/include/cartographer_ros/metrics/internal/histogram.h b/cartographer_ros/include/cartographer_ros/metrics/internal/histogram.h
index b5d8404..e47f99b 100644
--- a/cartographer_ros/include/cartographer_ros/metrics/internal/histogram.h
+++ b/cartographer_ros/include/cartographer_ros/metrics/internal/histogram.h
@@ -50,8 +50,8 @@ class Histogram : public ::cartographer::metrics::Histogram {
   absl::Mutex mutex_;
   const std::map<std::string, std::string> labels_;
   const BucketBoundaries bucket_boundaries_;
-  std::vector<double> bucket_counts_ GUARDED_BY(mutex_);
-  double sum_ GUARDED_BY(mutex_);
+  std::vector<double> bucket_counts_ ABSL_GUARDED_BY(mutex_);
+  double sum_ ABSL_GUARDED_BY(mutex_);
 };
 
 }  // namespace metrics
diff --git a/cartographer_ros/include/cartographer_ros/node.h b/cartographer_ros/include/cartographer_ros/node.h
index f3527ca..f9fb9fb 100644
--- a/cartographer_ros/include/cartographer_ros/node.h
+++ b/cartographer_ros/include/cartographer_ros/node.h
@@ -168,7 +168,7 @@ class Node {
   bool ValidateTrajectoryOptions(const TrajectoryOptions& options);
   bool ValidateTopicNames(const TrajectoryOptions& options);
   cartographer_ros_msgs::msg::StatusResponse FinishTrajectoryUnderLock(
-      int trajectory_id) EXCLUSIVE_LOCKS_REQUIRED(mutex_);
+      int trajectory_id) ABSL_EXCLUSIVE_LOCKS_REQUIRED(mutex_);
   void MaybeWarnAboutTopicMismatch();
 
   // Helper function for service handlers that need to check trajectory states.
@@ -183,7 +183,7 @@ class Node {
 
   absl::Mutex mutex_;
   std::unique_ptr<cartographer_ros::metrics::FamilyFactory> metrics_registry_;
-  std::shared_ptr<MapBuilderBridge> map_builder_bridge_ GUARDED_BY(mutex_);
+  std::shared_ptr<MapBuilderBridge> map_builder_bridge_ ABSL_GUARDED_BY(mutex_);
 
   rclcpp::Node::SharedPtr node_;
   ::rclcpp::Publisher<::cartographer_ros_msgs::msg::SubmapList>::SharedPtr submap_list_publisher_;
diff --git a/cartographer_ros/src/occupancy_grid_node_main.cpp b/cartographer_ros/src/occupancy_grid_node_main.cpp
index 282b890..6139979 100644
--- a/cartographer_ros/src/occupancy_grid_node_main.cpp
+++ b/cartographer_ros/src/occupancy_grid_node_main.cpp
@@ -74,10 +74,10 @@ class Node : public rclcpp::Node
   absl::Mutex mutex_;
   rclcpp::CallbackGroup::SharedPtr callback_group_;
   rclcpp::executors::SingleThreadedExecutor::SharedPtr callback_group_executor_;
-  ::rclcpp::Client<cartographer_ros_msgs::srv::SubmapQuery>::SharedPtr client_ GUARDED_BY(mutex_);
-  ::rclcpp::Subscription<cartographer_ros_msgs::msg::SubmapList>::SharedPtr submap_list_subscriber_ GUARDED_BY(mutex_);
-  ::rclcpp::Publisher<::nav_msgs::msg::OccupancyGrid>::SharedPtr occupancy_grid_publisher_ GUARDED_BY(mutex_);
-  std::map<SubmapId, SubmapSlice> submap_slices_ GUARDED_BY(mutex_);
+  ::rclcpp::Client<cartographer_ros_msgs::srv::SubmapQuery>::SharedPtr client_ ABSL_GUARDED_BY(mutex_);
+  ::rclcpp::Subscription<cartographer_ros_msgs::msg::SubmapList>::SharedPtr submap_list_subscriber_ ABSL_GUARDED_BY(mutex_);
+  ::rclcpp::Publisher<::nav_msgs::msg::OccupancyGrid>::SharedPtr occupancy_grid_publisher_ ABSL_GUARDED_BY(mutex_);
+  std::map<SubmapId, SubmapSlice> submap_slices_ ABSL_GUARDED_BY(mutex_);
   rclcpp::TimerBase::SharedPtr occupancy_grid_publisher_timer_;
   std::string last_frame_id_;
   rclcpp::Time last_timestamp_;
diff --git a/cartographer_rviz/include/cartographer_rviz/drawable_submap.h b/cartographer_rviz/include/cartographer_rviz/drawable_submap.h
index fe9d5ba..e145c33 100644
--- a/cartographer_rviz/include/cartographer_rviz/drawable_submap.h
+++ b/cartographer_rviz/include/cartographer_rviz/drawable_submap.h
@@ -108,16 +108,16 @@ class DrawableSubmap : public QObject{
   Ogre::SceneNode* const submap_node_;
   Ogre::SceneNode* const submap_id_text_node_;
   std::vector<std::unique_ptr<OgreSlice>> ogre_slices_;
-  ::cartographer::transform::Rigid3d pose_ GUARDED_BY(mutex_);
+  ::cartographer::transform::Rigid3d pose_ ABSL_GUARDED_BY(mutex_);
   ::rviz_rendering::Axes pose_axes_;
   bool pose_axes_visible_;
   ::rviz_rendering::MovableText submap_id_text_;
-  std::chrono::milliseconds last_query_timestamp_ GUARDED_BY(mutex_);
-  bool query_in_progress_ GUARDED_BY(mutex_) = false;
-  int metadata_version_ GUARDED_BY(mutex_) = -1;
+  std::chrono::milliseconds last_query_timestamp_ ABSL_GUARDED_BY(mutex_);
+  bool query_in_progress_ ABSL_GUARDED_BY(mutex_) = false;
+  int metadata_version_ ABSL_GUARDED_BY(mutex_) = -1;
   std::future<void> rpc_request_future_;
   std::unique_ptr<::cartographer::io::SubmapTextures> submap_textures_
-      GUARDED_BY(mutex_);
+      ABSL_GUARDED_BY(mutex_);
   float current_alpha_ = 0.f;
   std::unique_ptr<::rviz_common::properties::BoolProperty> visibility_;
 };
diff --git a/cartographer_rviz/include/cartographer_rviz/submaps_display.h b/cartographer_rviz/include/cartographer_rviz/submaps_display.h
index 4b128aa..99c5cea 100644
--- a/cartographer_rviz/include/cartographer_rviz/submaps_display.h
+++ b/cartographer_rviz/include/cartographer_rviz/submaps_display.h
@@ -97,7 +97,7 @@ class SubmapsDisplay
   std::unique_ptr<std::string> map_frame_;
   ::rviz_common::properties::StringProperty* tracking_frame_property_;
   Ogre::SceneNode* map_node_ = nullptr;  // Represents the map frame.
-  std::map<int, std::unique_ptr<Trajectory>> trajectories_ GUARDED_BY(mutex_);
+  std::map<int, std::unique_ptr<Trajectory>> trajectories_ ABSL_GUARDED_BY(mutex_);
   absl::Mutex mutex_;
   ::rviz_common::properties::BoolProperty* slice_high_resolution_enabled_;
   ::rviz_common::properties::BoolProperty* slice_low_resolution_enabled_;
-- 
2.43.0

